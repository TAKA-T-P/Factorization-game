<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êï∞Â≠¶„Éê„Éà„É´ - Â±ïÈñã„ÉªÂõ†Êï∞ÂàÜËß£„Ç≤„Éº„É†</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            max-width: 100vw;
            height: 100vh;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            text-align: center;
            position: relative;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        .title-screen {
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.1) 0%, transparent 70%);
        }

        .title {
            font-size: clamp(24px, 6vw, 48px);
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #00ff88, 0 0 30px #00ff88, 0 0 40px #00ff88; }
            to { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, 0 0 30px #00ff88; }
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #001122, #003344);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 15px 30px;
            font-size: clamp(16px, 4vw, 24px);
            font-family: inherit;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: 700;
            min-height: 60px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #003344, #005566);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .game-screen {
            padding: 20px;
            justify-content: space-between;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .score, .timer {
            font-size: clamp(16px, 4vw, 24px);
            font-weight: 700;
            text-shadow: 0 0 10px currentColor;
        }

        .timer {
            color: #ff6b6b;
        }

        .question-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .question {
            font-size: clamp(18px, 5vw, 32px);
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 15px #00ff88;
            line-height: 1.2;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .answer-btn {
            background: linear-gradient(45deg, #0d1421, #1a2332);
            border: 2px solid #00aa66;
            color: #00ff88;
            padding: 15px 10px;
            font-size: clamp(14px, 3.5vw, 20px);
            font-family: inherit;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-btn:hover {
            background: linear-gradient(45deg, #1a2332, #2a3442);
            box-shadow: 0 0 15px rgba(0, 170, 102, 0.5);
        }

        .answer-btn.selected {
            background: linear-gradient(45deg, #004422, #006633);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.7);
        }

        .answer-btn.correct {
            background: linear-gradient(45deg, #006633, #00aa44);
            border-color: #00ff88;
            animation: correct-flash 0.5s ease;
        }

        .answer-btn.wrong {
            background: linear-gradient(45deg, #661100, #aa2200);
            border-color: #ff4444;
            animation: wrong-flash 0.5s ease;
        }

        @keyframes correct-flash {
            0%, 100% { background: linear-gradient(45deg, #006633, #00aa44); }
            50% { background: linear-gradient(45deg, #00aa44, #00ff66); }
        }

        @keyframes wrong-flash {
            0%, 100% { background: linear-gradient(45deg, #661100, #aa2200); }
            50% { background: linear-gradient(45deg, #aa2200, #ff4444); }
        }

        .result-screen {
            padding: 20px;
            justify-content: flex-start;
        }

        .result-header {
            margin-bottom: 30px;
        }

        .result-title {
            font-size: clamp(20px, 5vw, 36px);
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #00ff88;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(45deg, #001122, #002244);
            border: 1px solid #00aa66;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: clamp(12px, 3vw, 16px);
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: clamp(16px, 4vw, 24px);
            font-weight: 700;
            text-shadow: 0 0 10px currentColor;
        }

        .history {
            background: linear-gradient(45deg, #001122, #002244);
            border: 1px solid #00aa66;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-title {
            font-size: clamp(14px, 3.5vw, 18px);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .history-item {
            font-size: clamp(12px, 3vw, 14px);
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0, 170, 102, 0.1);
            border-radius: 4px;
            line-height: 1.3;
        }

        .history-item.correct {
            color: #00ff88;
        }

        .history-item.wrong {
            color: #ff6b6b;
        }

        .result-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
        }

        .factors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .factors-grid .answer-btn:nth-child(8) {
            background: linear-gradient(45deg, #2a1a0d, #4a2a1d);
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .factors-grid .answer-btn:nth-child(8):hover {
            background: linear-gradient(45deg, #4a2a1d, #6a3a2d);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
        }

        .audio-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: 2px solid #00aa66;
            color: #00ff88;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(0, 255, 136, 0.2);
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .game-header {
                margin-bottom: 15px;
            }

            .answer-grid, .factors-grid {
                gap: 8px;
            }

            .answer-btn {
                min-height: 50px;
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="audio-toggle" onclick="toggleAudio()" title="Èü≥Â£∞„ÅÆ„Ç™„É≥/„Ç™„Éï">üîä</button>

        <div id="titleScreen" class="screen title-screen active">
            <h1 class="title">Êï∞Â≠¶„Éê„Éà„É´</h1>
            <p style="font-size: clamp(14px, 3.5vw, 18px); margin-bottom: 30px;">Â±ïÈñã„ÉªÂõ†Êï∞ÂàÜËß£„ÅÆË®àÁÆó„Ç≤„Éº„É†</p>
            <div class="mode-buttons">
                <button class="btn" onclick="startGame('expand')">Â±ïÈñã„É¢„Éº„Éâ</button>
                <button class="btn" onclick="startGame('factorize')">Âõ†Êï∞ÂàÜËß£„É¢„Éº„Éâ</button>
            </div>
        </div>

        <div id="gameScreen" class="screen game-screen">
            <div class="game-header">
                <div class="score">„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
                <div class="timer">ÊÆã„ÇäÊôÇÈñì: <span id="timeLeft">60</span>Áßí</div>
            </div>
            <div class="question-area">
                <div id="question" class="question"></div>
                <div id="answerGrid" class="answer-grid"></div>
            </div>
        </div>

        <div id="resultScreen" class="screen result-screen">
            <div class="result-header">
                <h2 class="result-title">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
                <div class="result-stats">
                    <div class="stat-item">
                        <div class="stat-label">Ê≠£Ëß£Êï∞</div>
                        <div class="stat-value" id="correctCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">‰∏çÊ≠£Ëß£Êï∞</div>
                        <div class="stat-value" id="wrongCount" style="color: #ff6b6b;">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢</div>
                        <div class="stat-value" id="finalScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">„Éè„Ç§„Çπ„Ç≥„Ç¢</div>
                        <div class="stat-value" id="highScore" style="color: #ffaa00;">0</div>
                    </div>
                </div>
            </div>
            <div class="history">
                <div class="history-title">ÂïèÈ°åÂ±•Ê≠¥</div>
                <div id="historyList"></div>
            </div>
            <div class="result-buttons">
                <button class="btn" onclick="retryGame()">„É™„Éà„É©„Ç§</button>
                <button class="btn" onclick="goToTitle()">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>
            </div>
        </div>
    </div>

    <script>
        let gameMode = '';
        let score = 0;
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let timeLeft = 60;
        let timer = null;
        let currentQuestion = null;
        let selectedAnswers = [];
        let questionHistory = [];
        let audioEnabled = true;

        const correctSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMWDDiO1O7Igg==');
        const wrongSound = new Audio('data:audio/wav;base64,UklGRgQGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YeMFAAD/8c/S6dHRzNHK0cnRytHM0dHR0tHR0dHS0dHRytHK0dHR0dHR0c3Q0s/S6dHK0cnQ0tHRzNLS0dHK0cnM0dHSy9HN');

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.querySelector('.audio-toggle').textContent = audioEnabled ? 'üîä' : 'üîá';
        }

        function playSound(sound) {
            if (audioEnabled) {
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function startGame(mode) {
            gameMode = mode;
            score = 0;
            correctAnswers = 0;
            wrongAnswers = 0;
            timeLeft = 60;
            selectedAnswers = [];
            questionHistory = [];

            document.getElementById('score').textContent = score;
            document.getElementById('timeLeft').textContent = timeLeft;

            showScreen('gameScreen');
            generateQuestion();
            startTimer();
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endGame();
                }
            }, 1000);
        }

        function generateQuestion() {
            selectedAnswers = [];
            const answerGrid = document.getElementById('answerGrid');
            answerGrid.className = gameMode === 'factorize' ? 'factors-grid' : 'answer-grid';

            if (gameMode === 'expand') {
                generateExpandQuestion();
            } else {
                generateFactorizeQuestion();
            }
        }

        function generateExpandQuestion() {
            const a = getRandomNonZero();
            const b = getRandomNonZero();

            const xCoeff = a + b;
            const constant = a * b;

            let questionText = `(x${a >= 0 ? '+' : ''}${a})(x${b >= 0 ? '+' : ''}${b}) = x¬≤`;

            if (xCoeff !== 0 && constant !== 0) {
                questionText += '____';
            } else if (xCoeff !== 0) {
                questionText += `${xCoeff >= 0 ? '+' : ''}${xCoeff}x`;
            } else {
                questionText += `${constant >= 0 ? '+' : ''}${constant}`;
            }

            currentQuestion = {
                text: questionText,
                xCoeff: xCoeff,
                constant: constant,
                original: `(x${a >= 0 ? '+' : ''}${a})(x${b >= 0 ? '+' : ''}${b})`,
                answer: `x¬≤${xCoeff !== 0 ? (xCoeff >= 0 ? '+' : '') + xCoeff + 'x' : ''}${constant !== 0 ? (constant >= 0 ? '+' : '') + constant : ''}`
            };

            document.getElementById('question').textContent = questionText;
            generateExpandAnswers();
        }

        function generateExpandAnswers() {
            const correctX = currentQuestion.xCoeff;
            const correctConst = currentQuestion.constant;

            const xChoices = new Set([correctX]);
            const constChoices = new Set([correctConst]);

            while (xChoices.size < 4) {
                xChoices.add(getRandomNonZero());
            }
            while (constChoices.size < 4) {
                constChoices.add(getRandomNonZero());
            }

            const xArray = Array.from(xChoices).sort(() => Math.random() - 0.5);
            const constArray = Array.from(constChoices).sort(() => Math.random() - 0.5);

            const answerGrid = document.getElementById('answerGrid');
            answerGrid.innerHTML = '';

            for (let i = 0; i < 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = `${xArray[i] >= 0 ? '+' : ''}${xArray[i]}x`;
                btn.onclick = () => selectExpandAnswer(btn, 'x', xArray[i]);
                answerGrid.appendChild(btn);
            }

            for (let i = 0; i < 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = `${constArray[i] >= 0 ? '+' : ''}${constArray[i]}`;
                btn.onclick = () => selectExpandAnswer(btn, 'const', constArray[i]);
                answerGrid.appendChild(btn);
            }
        }

        function selectExpandAnswer(button, type, value) {
            document.querySelectorAll('.answer-btn').forEach(btn => {
                if (btn !== button && btn.classList.contains('selected')) {
                    const otherType = btn.textContent.includes('x') ? 'x' : 'const';
                    if (otherType === type) {
                        btn.classList.remove('selected');
                    }
                }
            });

            button.classList.toggle('selected');

            if (button.classList.contains('selected')) {
                selectedAnswers = selectedAnswers.filter(ans => ans.type !== type);
                selectedAnswers.push({ type, value });
            } else {
                selectedAnswers = selectedAnswers.filter(ans => !(ans.type === type && ans.value === value));
            }

            checkExpandAnswer();
        }

        function checkExpandAnswer() {
            const needsX = currentQuestion.xCoeff !== 0;
            const needsConst = currentQuestion.constant !== 0;

            let hasCorrectX = !needsX;
            let hasCorrectConst = !needsConst;

            if (needsX) {
                hasCorrectX = selectedAnswers.some(ans => ans.type === 'x' && ans.value === currentQuestion.xCoeff);
            }
            if (needsConst) {
                hasCorrectConst = selectedAnswers.some(ans => ans.type === 'const' && ans.value === currentQuestion.constant);
            }

            if (hasCorrectX && hasCorrectConst) {
                if ((!needsX || selectedAnswers.some(ans => ans.type === 'x')) &&
                    (!needsConst || selectedAnswers.some(ans => ans.type === 'const'))) {

                    const wrongSelection = selectedAnswers.some(ans =>
                        (ans.type === 'x' && ans.value !== currentQuestion.xCoeff) ||
                        (ans.type === 'const' && ans.value !== currentQuestion.constant)
                    );

                    if (!wrongSelection) {
                        correctAnswer();
                        return;
                    }
                }
            }

            if (selectedAnswers.length > 0) {
                const wrongSelection = selectedAnswers.some(ans =>
                    (ans.type === 'x' && ans.value !== currentQuestion.xCoeff) ||
                    (ans.type === 'const' && ans.value !== currentQuestion.constant)
                );

                if (wrongSelection) {
                    wrongAnswer();
                }
            }
        }

        function generateFactorizeQuestion() {
            const p = getRandomNonZero();
            const q = getRandomNonZero();

            const xCoeff = p + q;
            const constant = p * q;

            const questionText = `x¬≤${xCoeff >= 0 ? '+' : ''}${xCoeff}x${constant >= 0 ? '+' : ''}${constant} = ______`;

            currentQuestion = {
                text: questionText,
                p: p,
                q: q,
                original: `x¬≤${xCoeff >= 0 ? '+' : ''}${xCoeff}x${constant >= 0 ? '+' : ''}${constant}`,
                answer: p === q ? `(x${p >= 0 ? '+' : ''}${p})¬≤` : `(x${p >= 0 ? '+' : ''}${p})(x${q >= 0 ? '+' : ''}${q})`
            };

            document.getElementById('question').textContent = questionText;
            generateFactorizeAnswers();
        }

        function generateFactorizeAnswers() {
            const correctP = currentQuestion.p;
            const correctQ = currentQuestion.q;

            const choices = new Set([correctP, correctQ]);

            while (choices.size < 7) {
                choices.add(getRandomNonZero());
            }

            const choicesArray = Array.from(choices).sort(() => Math.random() - 0.5);

            const answerGrid = document.getElementById('answerGrid');
            answerGrid.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = `(x${choicesArray[i] >= 0 ? '+' : ''}${choicesArray[i]})`;
                btn.onclick = () => selectFactorizeAnswer(btn, choicesArray[i]);
                answerGrid.appendChild(btn);
            }

            const squareBtn = document.createElement('button');
            squareBtn.className = 'answer-btn';
            squareBtn.textContent = '¬≤';
            squareBtn.onclick = () => selectSquare(squareBtn);
            answerGrid.appendChild(squareBtn);
        }

        function selectFactorizeAnswer(button, value) {
            if (selectedAnswers.find(ans => ans.value === value)) {
                selectedAnswers = selectedAnswers.filter(ans => ans.value !== value);
                button.classList.remove('selected');
            } else if (selectedAnswers.length < 2) {
                selectedAnswers.push({ value, isSquare: false });
                button.classList.add('selected');
            }

            checkFactorizeAnswer();
        }

        function selectSquare(button) {
            if (selectedAnswers.find(ans => ans.isSquare)) {
                selectedAnswers = selectedAnswers.filter(ans => !ans.isSquare);
                button.classList.remove('selected');
            } else if (selectedAnswers.length === 1) {
                selectedAnswers.push({ isSquare: true });
                button.classList.add('selected');
            }

            checkFactorizeAnswer();
        }

        function checkFactorizeAnswer() {
            if (selectedAnswers.length === 2) {
                const values = selectedAnswers.filter(ans => !ans.isSquare).map(ans => ans.value);
                const hasSquare = selectedAnswers.some(ans => ans.isSquare);

                if (hasSquare && values.length === 1) {
                    if (values[0] === currentQuestion.p && currentQuestion.p === currentQuestion.q) {
                        correctAnswer();
                    } else {
                        wrongAnswer();
                    }
                } else if (!hasSquare && values.length === 2) {
                    if ((values.includes(currentQuestion.p) && values.includes(currentQuestion.q)) &&
                        currentQuestion.p !== currentQuestion.q) {
                        correctAnswer();
                    } else {
                        wrongAnswer();
                    }
                } else {
                    wrongAnswer();
                }
            }
        }

        function correctAnswer() {
            playSound(correctSound);
            score++;
            correctAnswers++;

            questionHistory.push({
                question: currentQuestion.original,
                answer: currentQuestion.answer,
                correct: true
            });

            document.getElementById('score').textContent = score;

            document.querySelectorAll('.answer-btn.selected').forEach(btn => {
                btn.classList.add('correct');
            });

            setTimeout(() => {
                generateQuestion();
            }, 1000);
        }

        function wrongAnswer() {
            playSound(wrongSound);
            score = Math.max(0, score - 1);
            wrongAnswers++;

            questionHistory.push({
                question: currentQuestion.original,
                answer: currentQuestion.answer,
                correct: false
            });

            document.getElementById('score').textContent = score;

            document.querySelectorAll('.answer-btn.selected').forEach(btn => {
                btn.classList.add('wrong');
            });

            setTimeout(() => {
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.classList.remove('selected', 'wrong');
                });
                selectedAnswers = [];
            }, 1000);
        }

        function endGame() {
            const highScoreKey = `highScore_${gameMode}`;
            const currentHighScore = parseInt(localStorage.getItem(highScoreKey) || '0');
            const newHighScore = Math.max(score, currentHighScore);
            localStorage.setItem(highScoreKey, newHighScore.toString());

            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('wrongCount').textContent = wrongAnswers;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('highScore').textContent = newHighScore;

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            questionHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.correct ? 'correct' : 'wrong'}`;
                div.textContent = `${item.question} = ${item.answer}`;
                historyList.appendChild(div);
            });

            showScreen('resultScreen');
        }

        function retryGame() {
            startGame(gameMode);
        }

        function goToTitle() {
            if (timer) {
                clearInterval(timer);
            }
            showScreen('titleScreen');
        }

        function getRandomNonZero() {
            let num;
            do {
                num = Math.floor(Math.random() * 21) - 10;
            } while (num === 0);
            return num;
        }
    </script>
</body>
</html>